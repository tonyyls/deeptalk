---
description: 通过询问最多5个有针对性的澄清问题来识别和减少功能规格中的未充分指定区域，并将答案直接编码到规格文件中。
---

## 目标

识别并减少当前功能规格中的歧义、未充分指定和覆盖差距，通过：

1. 对规格进行结构化的歧义和覆盖扫描
2. 生成最多5个有针对性的澄清问题
3. 将用户答案直接集成到规格文件中

## 用户输入

```text
$ARGUMENTS
```

您**必须**在继续之前考虑用户输入（如果不为空）。

## 执行步骤

### 1. 先决条件检查

- 从仓库根目录运行 `.specify/scripts/bash/check-prerequisites.sh --json` 并解析JSON获取FEATURE_DIR和AVAILABLE_DOCS列表
- 所有文件路径必须是绝对路径
- 对于参数中的单引号如"I'm Groot"，使用转义语法：例如'I'\''m Groot'（或如果可能使用双引号："I'm Groot"）

### 2. 加载规格文件

从FEATURE_DIR加载`spec.md`。如果不存在，错误退出并建议运行`/speckit.specify`。

### 3. 结构化歧义和覆盖扫描

对规格执行系统性扫描，检查以下类别：

#### A. 功能范围
- 核心功能是否明确定义？
- 边界和限制是否清楚？
- 与现有系统的集成点是否指定？

#### B. 领域和数据模型
- 关键实体及其属性是否定义？
- 数据关系和约束是否清楚？
- 数据验证规则是否指定？

#### C. 交互和用户体验流程
- 用户旅程是否完整映射？
- 交互模式是否一致？
- 错误状态和恢复路径是否定义？

#### D. 非功能质量属性
- 性能要求是否量化？
- 安全和隐私考虑是否涵盖？
- 可访问性要求是否指定？
- 可扩展性和可维护性是否考虑？

#### E. 集成
- 外部依赖关系是否识别？
- API合同和数据格式是否定义？
- 第三方服务集成是否指定？

#### F. 边缘情况
- 异常场景是否涵盖？
- 边界条件是否定义？
- 故障模式和恢复是否指定？

#### G. 约束
- 技术约束是否记录？
- 业务约束是否清楚？
- 资源限制是否考虑？

#### H. 术语
- 关键术语是否一致定义？
- 领域特定语言是否澄清？
- 缩写和首字母缩略词是否解释？

#### I. 完成信号
- 验收标准是否可测量？
- 完成定义是否清楚？
- 成功指标是否定义？

#### J. 杂项/占位符
- 是否存在TODO或占位符？
- 是否有未解决的问题？
- 是否有需要进一步研究的区域？

### 4. 生成候选问题优先队列

基于扫描结果：

1. **识别关键差距**：按影响和紧急性对发现的问题进行排序
2. **生成候选问题**：为每个关键差距制定具体的澄清问题（最多10个总候选问题）
3. **优先排序**：选择前5个问题进行此会话
4. **格式化问题**：
   - 对于多选：提供A-E选项的表格格式
   - 对于简短答案：提供开放式问题
   - 包括上下文和为什么需要澄清的原因

**问题格式示例**：

**多选格式**：
```
Q1: 用户身份验证的范围应该是什么？

| 选项 | 描述 | 影响 |
|------|------|------|
| A | 仅基本登录/注销 | 最小实现 |
| B | 包括社交登录 | 需要第三方集成 |
| C | 完整的用户管理 | 需要管理界面 |
| D | 企业SSO集成 | 需要SAML/OAuth |

为什么重要：当前规格提到"用户身份验证"但没有指定范围，这影响架构决策和实现复杂性。
```

**简短答案格式**：
```
Q2: 系统应该支持的最大并发用户数是多少？

为什么重要：性能要求提到"可扩展"但没有具体目标，这对基础设施规划至关重要。
```

### 5. 顺序交互问题循环

对于每个选定的问题：

1. **呈现问题**：清楚地显示问题、选项（如果适用）和上下文
2. **收集答案**：等待用户响应
3. **验证答案**：确保答案完整且可理解
4. **立即集成**：将答案直接编码到规格文件中的适当部分
5. **确认更新**：向用户显示规格的更新部分

**集成策略**：
- 将答案添加到现有相关部分
- 如果需要，创建新部分
- 使用清晰的标题和结构
- 保持与现有规格风格的一致性

### 6. 验证和最终确定

在所有问题回答后：

1. **一致性检查**：验证新信息与现有规格的一致性
2. **完整性验证**：确认关键差距已解决
3. **格式验证**：确保规格保持适当的结构和格式

### 7. 最终报告

提供澄清过程的摘要：

```markdown
## 澄清会话摘要

**已解决的区域**：
- [列出已澄清的主要区域]

**规格更新**：
- [总结对规格所做的更改]

**剩余差距**：
- [列出任何未解决的问题]

**建议的后续步骤**：
- [推荐下一步行动]
```

## 行为规则

1. **问题限制**：每次会话不超过5个问题
2. **用户控制**：如果用户说"停止"、"足够"或类似信号，立即停止提问
3. **渐进式澄清**：从最关键的差距开始
4. **直接集成**：不要等到最后才更新规格 - 在收到每个答案后立即集成
5. **无关键歧义时**：如果没有发现关键歧义，报告规格质量良好并建议可能的增强

## 特殊情况处理

### 如果规格质量已经很高
如果扫描显示最少的歧义：
1. 报告规格质量良好
2. 提及任何次要改进机会
3. 建议进行下一步（如`/speckit.plan`）

### 如果发现超过10个关键问题
1. 专注于最高影响的问题
2. 在报告中记录其他问题
3. 建议额外的澄清会话

### 如果用户提供不完整的答案
1. 礼貌地要求澄清
2. 提供具体的指导
3. 如果仍然不清楚，记录假设并继续

## 输出格式

澄清会话应遵循此结构：

```markdown
# 规格澄清会话

## 已识别的差距
[扫描结果摘要]

## 澄清问题

### Q1: [问题标题]
[问题详情和选项]

**用户答案**: [记录答案]
**集成**: [描述如何将答案添加到规格中]

[对每个问题重复]

## 更新的规格部分
[显示规格的更新部分]

## 会话摘要
[如上所述的最终报告]
```